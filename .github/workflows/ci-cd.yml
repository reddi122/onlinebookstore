name: Java Web App CI/CD

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      NEXUS_URL: ${{ secrets.NEXUS_URL }}
      NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
      NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
      NEXUS_REPO: maven-releases
      NEXUS_GROUP: com/web/onlinebookstore
      NEXUS_ARTIFACT: onlinebookstore-add
      TOMCAT_MANAGER_URL: ${{ secrets.TOMCAT_MANAGER_URL }}
      TOMCAT_MANAGER_USER: ${{ secrets.TOMCAT_MANAGER_USER }}
      TOMCAT_MANAGER_PASS: ${{ secrets.TOMCAT_MANAGER_PASS }}

    steps:
      # === Stage 1: Checkout Code ===
      - name: üì¶ Checkout source
        uses: actions/checkout@v4

      # === Stage 2: Set up JDK and Maven ===
      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # === Stage 3: SonarQube Analysis ===
      - name: üîç Run SonarQube Analysis
        run: |
          mvn clean verify sonar:sonar \
            -DskipTests \
            -Dsonar.projectKey=onlinebookstore-App \
            -Dsonar.host.url=${{ env.SONAR_HOST_URL }} \
            -Dsonar.login=${{ env.SONAR_TOKEN }}

      # === Stage 4: Build Artifact ===
      - name: ‚öôÔ∏è Build WAR package
        run: |
          mvn clean package -DskipTests
          echo "‚úÖ Build Completed!"
          ls -lh target/*.war || true

      # === Stage 5: Upload Artifact to Nexus ===
      - name: üì§ Upload WAR to Nexus
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          VERSION="0.0.${{ github.run_number }}"
          FILE_NAME=$(basename "$WAR_FILE")

          echo "Uploading $FILE_NAME to Nexus as version $VERSION..."
          curl -v -u "${{ env.NEXUS_USERNAME }}:${{ env.NEXUS_PASSWORD }}" \
            --upload-file "$WAR_FILE" \
            "${{ env.NEXUS_URL }}/repository/${{ env.NEXUS_REPO }}/${{ env.NEXUS_GROUP }}/${{ env.NEXUS_ARTIFACT }}/${VERSION}/${{ env.NEXUS_ARTIFACT }}-${VERSION}.war"

          echo "‚úÖ Uploaded successfully!"

      # === Stage 6: Deploy to Tomcat (directly from built WAR) ===
      - name: üöÄ Deploy WAR to Tomcat
        run: |
          set -e
          WAR_FILE=$(ls target/*.war | head -1)
          APP_NAME=$(echo "$WAR_FILE" | sed 's/-[0-9].*//')

          echo "üßπ Removing old deployment..."
          curl -u "${{ env.TOMCAT_MANAGER_USER }}:${{ env.TOMCAT_MANAGER_PASS }}" \
            "${{ env.TOMCAT_MANAGER_URL }}/undeploy?path=/${APP_NAME}" || true

          echo "üöÄ Deploying new WAR to Tomcat..."
          curl -u "${{ env.TOMCAT_MANAGER_USER }}:${{ env.TOMCAT_MANAGER_PASS }}" \
            --upload-file "$WAR_FILE" \
            "${{ env.TOMCAT_MANAGER_URL }}/deploy?path=/${APP_NAME}&update=true"

          echo "‚úÖ Deployment successful!"
